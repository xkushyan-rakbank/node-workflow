!function(e,s){"object"==typeof exports&&"undefined"!=typeof module?s(exports,require("@tensorflow/tfjs-core"),require("@tensorflow/tfjs-converter")):"function"==typeof define&&define.amd?define(["exports","@tensorflow/tfjs-core","@tensorflow/tfjs-converter"],s):s(e.podium={},e.tf,e.tf)}(this,function(e,s,t){"use strict";function o(e,s,t,o){return new(t||(t=Promise))(function(i,n){function r(e){try{c(o.next(e))}catch(e){n(e)}}function a(e){try{c(o.throw(e))}catch(e){n(e)}}function c(e){var s;e.done?i(e.value):(s=e.value,s instanceof t?s:new t(function(e){e(s)})).then(r,a)}c((o=o.apply(e,s||[])).next())})}const i=128,n=896,r=.3,a=.75,c=2,d=4,u=112,l=28,p=1700,h=3,f=4,_={num_layers:4,min_scale:.1484375,max_scale:.75,input_size_width:i,input_size_height:i,anchor_offset_x:.5,anchor_offset_y:.5,aspect_ratios:[1],strides:[8,16,16,16],fixed_anchor_size:!0,reduce_boxes_in_lowest_layer:!1,interpolated_scale_aspect_ratio:1};function m(){return _.strides.length}function y(e,s,t,o){return e+(s-e)*t/(o-1)}function g(e,t){return s.tidy(()=>{const o=e.toFloat(),i=s.div(o,255);o.dispose();const n=s.sub(i,.5);i.dispose();const r=s.mul(n,2),a=r.shape[1],c=r.shape[2],d=Math.min(t/a,t/c),u=d*a,l=d*c,p=(t-u)/2,h=t-u-p,f=(t-l)/2,_=t-l-f,m=s.image.resizeBilinear(r,[u,l]);r.dispose();const y=s.pad(m,[[0,0],[p,h],[f,_],[0,0]]);return m.dispose(),y})}const b={num_classes:1,num_boxes:n,num_coord:16,box_coord_offset:0,keypoint_coord_offset:4,num_keypoint:6,num_valuer_per_keypoint:2,sigmoid_score:!0,score_clipping_thresh:100,reverse_output_order:!0,x_scale:128,y_scale:128,w_scale:128,h_scale:128,flip_vertically:!1,apply_exponential_on_box_size:!1,num_box_coords:d};function v(e,t,o){const[i,n,r]=s.tidy(()=>{let i=t.squeeze([0,2]);i=s.sigmoid(i);const n=o.squeeze([0]),r=s.slice2d(n,[0,0],[-1,b.keypoint_coord_offset]),a=s.slice2d(n,[0,b.keypoint_coord_offset],[-1,-1]);n.dispose();let[c,d,u,l]=s.unstack(r,1);const[p,h,f,_]=s.unstack(e,1);c=s.add(s.div(c,s.mul(b.x_scale,f)),p),d=s.add(s.div(d,s.mul(b.y_scale,_)),h),u=s.div(u,s.mul(b.w_scale,f)),l=s.div(l,s.mul(b.h_scale,_));const m=s.sub(c,s.div(u,2)),y=s.sub(d,s.div(l,2)),g=s.add(c,s.div(u,2)),v=s.add(d,s.div(l,2)),k=s.stack([m,y,g,v],1),x=s.reshape(a,[b.num_boxes,b.num_keypoint,b.num_valuer_per_keypoint]),[M,w]=s.unstack(x,2),z=s.unstack(M,1);let j=[];for(let e=0;e<z.length;e++){const t=s.add(s.div(z[e],s.mul(b.x_scale,f)),p);j.push(t)}const P=s.stack(j,1),A=s.unstack(w,1);let F=[];for(let e=0;e<A.length;e++){const t=s.add(s.div(A[e],s.mul(b.y_scale,_)),h);F.push(t)}const q=s.stack(F,1);return[k,s.stack([P,q],2),i]});return[i,n,r]}function k(e,t,i){return o(this,void 0,void 0,function*(){const o=s.squeeze(e,[0]),n=s.sigmoid(o),r=yield n.array();e.dispose(),o.dispose(),n.dispose();let a=r[0]/t;for(let e=0;e<t-1;e++)r[e]>i&&(a+=r[e+1]/t);return a})}class x{constructor(e,t,o=!0){this.VERSION="0130",this.jedi=e,this.pokerface=t,this.anchors=s.tensor2d(function(){const e=[];let s=0;for(;s<m();){let t=[],o=s;for(;o<m()&&_.strides[o]==_.strides[s];){y(_.min_scale,_.max_scale,o,m());for(let e=0;e<_.aspect_ratios.length;e++)t.push(_.aspect_ratios[e]);let e=y(_.min_scale,_.max_scale,o+1,m());o==m()-1&&(e=1),t.push(_.interpolated_scale_aspect_ratio),o+=1}let i=_.strides[s],n=Math.ceil(_.input_size_height/i),r=Math.ceil(_.input_size_width/i);for(let s=0;s<n;s++)for(let o=0;o<r;o++)for(let i=0;i<t.length;i++){let t=[(o+_.anchor_offset_x)/r,(s+_.anchor_offset_y)/n,1,1];e.push(t)}s=o}return e}(),[n,d],"float32"),this.returnFaceAttributes=o}imageProcess(e){return o(this,void 0,void 0,function*(){return s.tidy(()=>{const t=g(e,i),o=this.jedi.predict(t);t.dispose();const n=o[0],d=o[1],[u,l,p]=v(this.anchors,n,d);n.dispose(),d.dispose();const[h,f,_]=function(e,t,o){const[i,n,d]=s.tidy(()=>{const[i,n,d,u]=s.unstack(e,1),l=s.stack([n,i,u,d],1),p=s.image.nonMaxSuppression(l,o,c,r,a),h=p.shape[0];let f=s.tensor2d([[-1,-1,-1,-1]],[1,4],"float32"),_=s.tensor3d([-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],[1,6,2],"float32");if(h>0){let o=s.slice(p,0,1);f=s.gather(e,o),_=s.gather(t,o)}return[f,_,h]});return[i,n,d]}(u,l,p);return u.dispose(),l.dispose(),p.dispose(),[h,f,_]})})}imageProcessWithAsyncNMS(e){return o(this,void 0,void 0,function*(){const[t,o,n]=s.tidy(()=>{const s=g(e,i),t=this.jedi.predict(s);s.dispose();const o=t[0],n=t[1],[r,a,c]=v(this.anchors,o,n);return o.dispose(),n.dispose(),[r,a,c]}),[d,u,l,p]=s.unstack(t,1),h=s.stack([u,d,p,l],1);d.dispose(),u.dispose(),l.dispose(),p.dispose();const f=yield s.image.nonMaxSuppressionAsync(h,n,c,r,a);h.dispose(),n.dispose();const[_,m,y]=function(e,t,o){const[i,n,r]=s.tidy(()=>{const i=o.shape[0];let n=s.tensor2d([[-1,-1,-1,-1]],[1,4],"float32"),r=s.tensor3d([-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],[1,6,2],"float32");if(i>0){let i=s.slice(o,0,1);n=s.gather(e,i),r=s.gather(t,i)}return[n,r,i]});return[i,n,r]}(t,o,f);return t.dispose(),o.dispose(),f.dispose(),[_,m,y]})}detectionsProcess(e,t,n){return o(this,void 0,void 0,function*(){return s.tidy(()=>{const a=e.shape[1],c=e.shape[2],u=function(e,s,t){const o=s/e,i=t/t;let n=(1-i/o)/2;o<=i&&(n=0);let r=(1-o/i)/2;return o>=i&&(r=0),[n,r,n,r]}(a,c,i),[l,p]=function(e,t,o){const[i,n]=s.tidy(()=>{const i=e[0],n=e[1],r=e[2],a=n+e[3],c=i+r,[d,u,l,p]=s.unstack(t,1),h=s.sub(l,d),f=s.sub(p,u),_=s.div(s.sub(d,n),s.sub(1,a)),m=s.div(s.sub(u,i),s.sub(1,c)),y=s.div(h,s.sub(1,a)),g=s.div(f,s.sub(1,c)),[b,v]=s.unstack(o,2),k=s.div(s.sub(b,n),s.sub(1,a)),x=s.div(s.sub(v,i),s.sub(1,c));return[s.stack([_,m,s.add(_,y),s.add(m,g)],1),s.stack([k,x],2)]});return[i,n]}(u,t,n);t.dispose(),n.dispose();const[h,f]=function(e,t,o,i){const[n,r]=s.tidy(()=>{const n=s.tensor1d([t,e],"float32");let r=s.reshape(o,[-1,d/2,2]);r=s.mul(r,n);let a=s.mul(i,n);const c=s.reshape(r,[-1,d]),[u,l,p,h]=s.unstack(c,1),f=s.maximum(u,s.zerosLike(u)),_=s.maximum(l,s.zerosLike(l)),m=s.minimum(p,s.mul(s.onesLike(p),t-1)),y=s.minimum(h,s.mul(s.onesLike(h),e-1));return[s.stack([f,_,m,y],1),a]});return[n,r]}(a,c,l,p);return l.dispose(),p.dispose(),o=h,r=f,s.tidy(()=>{let e=s.squeeze(o,[0]),t=s.squeeze(r,[0]);return[e.toInt(),t.toInt()]})});var o,r})}faceProcess(e,t,i){return o(this,void 0,void 0,function*(){const n=s.tidy(()=>{const[o,n]=function(e,t,o){return s.tidy(()=>{const i=e.shape,n=i[2],r=i[1];let a=t[0],c=t[1],d=t[2],h=t[3],f=d-a,_=h-c,m=a+.5*f,y=c+.5*_;f*=1.3,_*=1.6,a=Math.round(m-.5*f),c=Math.round(y-.5*_),d=Math.round(m+.5*f),a=Math.max(Math.min(a,n-2),0),c=Math.max(Math.min(c,r-2),0),d=Math.max(Math.min(d,n),a+1),h=Math.max(Math.min(h,r),c+1);let g=s.slice4d(e,[0,c,a,0],[-1,h-c,d-a,-1]);g=s.image.resizeBilinear(g,[u,u]);const b=s.scalar(-1,"float32"),v=s.div(g,255),[k,x,M]=s.unstack(v,-1),w=s.add(s.add(s.mul(.299,s.mean(k)),s.mul(.587,s.mean(x))),s.mul(.114,s.mean(M)));v.dispose(),k.dispose(),x.dispose(),M.dispose();let z=[];for(let e=0;e<u;e+=l)for(let t=0;t<u;t+=l)z.push(s.slice4d(g,[0,e,t,0],[-1,l,l,-1]));const j=s.concat(z,0),P=j.shape[0],A=s.tensor2d([[0,1,0],[1,-4,1],[0,1,0]],[3,3],"float32"),F=s.expandDims(A,2),q=s.expandDims(F,3),L=s.concat([q,q,q],2),S=s.conv2d(j,L,1,"valid"),O=s.moments(S,[1,2,3]).variance;let R=s.greater(O,p);R=s.sum(s.cast(R,"int32")),R=s.cast(R,"float32");const D=s.div(R,P),I=t[0],N=t[1],B=t[2],E=t[3],G=(2*o[2][0]-(I+B))/(B-I),T=(2*o[2][1]-(N+E))/(E-N),W=s.scalar(G),V=s.scalar(T),C=s.stack([b,w,D,W,V],0);return z.map(s.dispose),j.dispose(),A.dispose(),S.dispose(),O.dispose(),R.dispose(),b.dispose(),w.dispose(),D.dispose(),W.dispose(),V.dispose(),[g,C]})}(e,t,i),r=this.pokerface.predict(o);return e.dispose(),[r,n]}),r=yield function(e){return o(this,void 0,void 0,function*(){const t=yield k(e[5],h-1,.5),o=yield k(e[0],f-1,.5),i=yield k(e[6],f-1,.5),n=Math.min(o,i),r=yield s.tidy(()=>s.squeeze(s.concat([e[1],e[2],e[7],e[3],e[4]],1),[0])).array();return[r[4],n,t,r[0],r[1],r[2],r[3]]})}(n[0]),a=yield n[1].array();return[...r,...a]})}estimateFaces(e,t=!1,i=!1){return o(this,void 0,void 0,function*(){const[,o]=function(e){return e instanceof s.Tensor?[e.shape[0],e.shape[1]]:[e.height,e.width]}(e),n=s.tidy(()=>(e instanceof s.Tensor||(e=s.browser.fromPixels(e)),e.toFloat().expandDims(0))),[r,a,c]=yield this.imageProcessWithAsyncNMS(n);if(c<1){const e=(d=n,s.tidy(()=>{const e=s.div(d,255),[t,o,i]=s.unstack(e,-1);return s.add(s.add(s.mul(.299,s.mean(t)),s.mul(.587,s.mean(o))),s.mul(.114,s.mean(i)))})),t=yield e.array();return n.dispose(),r.dispose(),a.dispose(),e.dispose(),{topLeft:[-1,-1],bottomRight:[-1,-1],landmarks:[[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1]],numOfAllFaces:c,motion_blur:-1,eyes_open:-1,smile:-1,object:-1,light_lighting:-1,light_exposure:-1,light_background:-1,brightness:-1,face_brightness:t,sharpness:-1,left_right:-1,up_down:-1,score:-1}}var d;const[u,l]=yield this.detectionsProcess(n,r,a);r.dispose(),a.dispose();const p=yield u.array();u.dispose();const h=yield l.array();l.dispose();let f=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-100];this.returnFaceAttributes&&!i&&(f=yield this.faceProcess(n,p,h)).push(function(e){let s=1;return e[0]>5&&(s=0),e[1]<.15?s=0:s-=.4*(1-e[1])*(1-e[1]),e[2]>.9?s=0:s-=.2*Math.abs(e[2]),e[3]>.7?s=0:s-=.35*Math.abs(e[3]),e[4]>.9?s=0:s-=.4*e[4]*e[4],e[5]<.13?s=0:s-=.175*Math.abs(.5-e[5]),e[5]>.9?s=0:s-=.175*Math.abs(.5-e[5]),e[6]>.97?s=0:s-=.15*Math.abs(.5-e[6]),s-=.55*(1-e[9]),Math.abs(e[10])>.6?s=0:s-=.35*Math.abs(e[10]),Math.abs(e[11])>.6?s=0:s-=.3*Math.abs(e[11]),Math.max(s,0)}(f)),n.dispose();let _={topLeft:p.slice(0,2),bottomRight:p.slice(2),landmarks:h,numOfAllFaces:c,motion_blur:f[0],eyes_open:f[1],smile:f[2],object:f[3],light_lighting:f[4],light_exposure:f[5],light_background:f[6],brightness:f[7],face_brightness:f[8],sharpness:f[9],left_right:f[10],up_down:f[11],score:f[12]};return t&&(_=function(e,s){let t,o,i;const[n,r]=e.topLeft,[a,c]=e.bottomRight;return t=[s-1-n,r],o=[s-1-a,c],null!=e.landmarks&&(i=e.landmarks.map(e=>[s-1-e[0],e[1]])),{topLeft:t,bottomRight:o,landmarks:i,numOfAllFaces:e.numOfAllFaces,motion_blur:e.motion_blur,eyes_open:e.eyes_open,smile:e.smile,object:e.object,light_lighting:e.light_lighting,light_exposure:e.light_exposure,light_background:e.light_background,brightness:e.brightness,face_brightness:e.face_brightness,sharpness:e.sharpness,left_right:e.left_right,up_down:e.up_down,score:e.score}}(_,o)),_})}}e.load=function(e,n,r=!0){return o(this,void 0,void 0,function*(){const o=yield t.loadGraphModel(e),a=r?yield t.loadGraphModel(n):null,c=o.predict(s.zeros([1,i,i,3]));return c[0].dataSync(),c[0].dispose(),c[1].dataSync(),c[1].dispose(),r&&a.predict(s.zeros([1,u,u,3])).forEach(function(e){e.dataSync(),e.dispose()}),new x(o,a,r)})},Object.defineProperty(e,"__esModule",{value:!0})});
